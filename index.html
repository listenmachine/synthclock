<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hour Drift — Minimal Time Gradient</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    --fg: #eaeaea;
    --panel: rgb(28 28 30 / 88%);
    --shadow: 0 8px 24px rgb(0 0 0 / 35%);
    --grain-opacity: .14;
  }
  html,body{height:100%}
  body{
    margin:0; height:100%;
    background:#0b0b0c; /* replaced by gradient */
    color:var(--fg); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    transition: background .6s ease;
  }

  /* Grain overlay */
  .grain{
    position:fixed; inset:0; z-index:2; pointer-events:none;
    mix-blend-mode: soft-light; opacity: var(--grain-opacity);
    background-repeat: repeat; background-size: auto;
  }

  /* Minimal controls */
  .topbar{
    position:fixed; top:18px; right:18px; display:flex; gap:10px; z-index:5;
    filter: drop-shadow(0 6px 18px rgb(0 0 0 / .35));
  }
  .btn{
    background:#1b1b1d; color:var(--fg); border:1px solid #333; padding:10px 14px;
    border-radius:14px; cursor:pointer; font-weight:600; letter-spacing:.2px;
  }
  .btn:hover{ filter:brightness(1.1) }
  .brand{
    position:fixed; left:18px; top:20px; font-weight:700; opacity:.85;
    text-shadow: 0 2px 12px rgb(0 0 0 / .45); z-index:5;
  }
  .hint{
    position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
    font-size:.9rem; opacity:.7; text-shadow: 0 2px 12px rgb(0 0 0 / .45); z-index:5;
  }

  /* Settings */
  dialog{
    border:none; border-radius:22px; padding:0; background:var(--panel); color:var(--fg);
    width:min(860px, 92vw); box-shadow: var(--shadow);
  }
  dialog::backdrop{ background: rgb(0 0 0 / .45) }
  .panel{ padding:18px }
  .panel h2{ margin:4px 0 14px; font-size:1.05rem; letter-spacing:.3px; }
  .grid{ display:grid; grid-template-columns: repeat(6,minmax(0,1fr)); gap:10px; }
  .sw{ background:#141416; border:1px solid #2d2e33; border-radius:12px; padding:8px; display:flex; flex-direction:column; align-items:center; gap:6px; }
  .sw label{ font-size:.8rem; opacity:.8; font-weight:600 }
  .sw input[type="color"]{ width:100%; height:38px; border:none; background:transparent; border-radius:10px; cursor:pointer; }
  .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:12px; flex-wrap:wrap }
  .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:#17171a; border:1px solid #2b2c31; font-weight:600 }
  .select{ padding:8px 12px; border-radius:12px; background:#17171a; color:var(--fg); border:1px solid #2b2c31; }
  .range{ display:flex; align-items:center; gap:10px; }
  .range input{ width:200px; }
  @media (max-width:760px){ .grid{ grid-template-columns: repeat(3,minmax(0,1fr)); } .range input{ width:150px; } }

  /* Tiny build tag */
  .version{position:fixed; right:14px; bottom:14px; font: 12px/1.2 ui-sans-serif,system-ui; opacity:.35}
</style>
</head>
<body>
  <div class="brand">Hour Drift</div>
  <div class="topbar" id="controls">
    <button class="btn" id="open">Colours</button>
    <button class="btn" id="hide">Hide</button>
  </div>
  <div class="hint">hour → next hour • press <b>H</b> to toggle controls</div>
  <div class="grain" id="grain" aria-hidden="true"></div>
  <div class="version" id="ver"></div>

  <!-- Settings -->
  <dialog id="panel">
    <div class="panel">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <h2>Hour colours (1–12)</h2>
        <button class="btn" id="close">Close</button>
      </div>
      <div class="grid" id="swGrid"></div>

      <div class="row">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <label class="pill"><input type="checkbox" id="twelve" checked /> 12-hour time</label>
          <label class="pill">Blend
            <select id="blend" class="select">
              <option value="oklch">OKLCH (perceptual)</option>
              <option value="oklch-long">OKLCH (long path)</option>
              <option value="hsl">HSL</option>
              <option value="srgb">sRGB (basic)</option>
              <option value="via-white">Via white</option>
              <option value="via-black">Via black</option>
            </select>
          </label>
          <label class="pill">Hue path
            <select id="huePath" class="select">
              <option value="short">Shortest</option>
              <option value="cw">Clockwise</option>
              <option value="ccw">Counter-clockwise</option>
            </select>
          </label>
        </div>

        <div class="range">
          <label class="pill">Grain <span id="grainVal">14%</span></label>
          <input type="range" id="grainAmt" min="0" max="30" value="14" />
          <label class="pill"><input type="checkbox" id="grainAnim" checked /> Animate</label>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
          <button class="btn" id="reset">Reset</button>
          <button class="btn" id="exportBtn">Export</button>
          <button class="btn" id="importBtn">Import</button>
        </div>
      </div>

      <p style="opacity:.75; margin-top:10px">
        Perceptual blending (OKLCH) keeps lightness/chroma pleasant so complements like yellow→blue
        arc through vivid hues instead of turning grey. Choose the hue path to travel via green (CW) or magenta (CCW).
      </p>
    </div>
  </dialog>

<script>
/* ===== Build tag ===== */
const BUILD = 'oklch-2025-09-11-v10';
document.getElementById('ver').textContent = BUILD;
console.info('HourDrift build:', BUILD);

/* ===== State ===== */
const DEFAULTS = {
  twelve: true,
  hours: [
    '#ffdf43', '#1e49ff', '#4bd964', '#34c0ff', '#9b59ff', '#ff9bd3',
    '#ff7e33', '#16c6a8', '#c6ff34', '#d96a7f', '#ff5a5f', '#e2902f'
  ],
  grainAmt: 14,
  grainAnim: true,
  blend: 'oklch',      // 'oklch' | 'oklch-long' | 'hsl' | 'srgb' | 'via-white' | 'via-black'
  huePath: 'cw'        // 'short' | 'cw' | 'ccw'
};

const store = {
  load(){ try{ return JSON.parse(localStorage.getItem('hourDrift')) || DEFAULTS }catch{ return DEFAULTS } },
  save(s){ localStorage.setItem('hourDrift', JSON.stringify(s)); }
};
let state = store.load();

/* ===== DOM ===== */
const controls = document.getElementById('controls');
const openBtn  = document.getElementById('open');
const hideBtn  = document.getElementById('hide');
const panel    = document.getElementById('panel');
const closeBtn = document.getElementById('close');
const grid     = document.getElementById('swGrid');
const twelve   = document.getElementById('twelve');

const blendSel  = document.getElementById('blend');
const huePathSel= document.getElementById('huePath');

const grainDiv   = document.getElementById('grain');
const grainAmtEl = document.getElementById('grainAmt');
const grainVal   = document.getElementById('grainVal');
const grainAnimEl= document.getElementById('grainAnim');

/* ===== UI ===== */
function buildSwatches(){
  grid.innerHTML = '';
  for(let i=1;i<=12;i++){
    const wrap = document.createElement('div'); wrap.className='sw';
    const lab = document.createElement('label'); lab.textContent = i;
    const inp = document.createElement('input'); inp.type='color'; inp.value = state.hours[i-1];
    inp.addEventListener('input', function(e){ state.hours[i-1]=e.target.value; store.save(state); });
    wrap.append(lab, inp); grid.appendChild(wrap);
  }
}
openBtn.onclick = function(){
  buildSwatches();
  twelve.checked=!!state.twelve;
  blendSel.value=state.blend;
  huePathSel.value=state.huePath;
  grainAmtEl.value=state.grainAmt; grainVal.textContent = state.grainAmt + '%';
  grainAnimEl.checked=!!state.grainAnim;
  panel.showModal();
};
closeBtn.onclick = function(){ panel.close(); };
hideBtn.onclick = function(){ controls.style.display='none'; };
document.addEventListener('keydown', function(e){ if((e.key||'').toLowerCase()==='h'){ controls.style.display = controls.style.display==='none' ? '' : 'none'; }});
twelve.onchange = function(e){ state.twelve=!!e.target.checked; store.save(state); };
blendSel.onchange = function(e){ state.blend = e.target.value; store.save(state); };
huePathSel.onchange = function(e){ state.huePath = e.target.value; store.save(state); };

document.getElementById('reset').onclick = function(){
  state = JSON.parse(JSON.stringify(DEFAULTS));
  store.save(state); buildSwatches(); applyGrain();
};
document.getElementById('exportBtn').onclick = function(){
  const blob = new Blob([JSON.stringify(state)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='hour-drift-settings.json'; a.click(); URL.revokeObjectURL(a.href);
};
document.getElementById('importBtn').onclick = function(){
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=function(){ const f=inp.files[0]; if(!f) return; const r=new FileReader();
    r.onload=function(){ try{
      const obj=JSON.parse(r.result);
      if(obj.hours) state.hours=obj.hours.slice(0,12);
      if(typeof obj.twelve==='boolean') state.twelve=obj.twelve;
      if(typeof obj.grainAmt==='number') state.grainAmt=Math.max(0,Math.min(30, obj.grainAmt));
      if(typeof obj.grainAnim==='boolean') state.grainAnim=obj.grainAnim;
      if(typeof obj.blend==='string') state.blend=obj.blend;
      if(typeof obj.huePath==='string') state.huePath=obj.huePath;
      store.save(state); buildSwatches(); applyGrain();
    }catch(e){} }; r.readAsText(f);
  }; inp.click();
};
grainAmtEl.oninput = function(e){ state.grainAmt = parseInt(e.target.value||0,10); grainVal.textContent = state.grainAmt + '%'; store.save(state); applyGrain(); };
grainAnimEl.onchange = function(e){ state.grainAnim = !!e.target.checked; store.save(state); applyGrain(); };

/* ===== Grain (tile-based) ===== */
var grainTimer = null;
function renderGrain(){
  var size = 128;
  if(!renderGrain.canvas){
    var c = document.createElement('canvas');
    c.width = size; c.height = size;
    renderGrain.canvas = c; renderGrain.ctx = c.getContext('2d', { willReadFrequently: true });
  }
  var c = renderGrain.canvas, ctx = renderGrain.ctx;
  var id = ctx.createImageData(size, size);
  var data = id.data;
  for(var i=0;i<data.length;i+=4){
    var v = (Math.random()*255)|0;
    data[i]=data[i+1]=data[i+2]=v; data[i+3]=255;
  }
  ctx.putImageData(id,0,0);
  grainDiv.style.backgroundImage = 'url(' + c.toDataURL() + ')';
}
function applyGrain(){
  document.documentElement.style.setProperty('--grain-opacity', (state.grainAmt/100).toString());
  grainDiv.style.display = state.grainAmt>0 ? 'block' : 'none';
  renderGrain();
  if(grainTimer){ clearInterval(grainTimer); grainTimer = null; }
  if(state.grainAnim && state.grainAmt>0){
    grainTimer = setInterval(renderGrain, 250);
  }
}

/* ===== Color utils (sRGB, OKLab/OKLCH, HSL) ===== */
function srgbToLinear(u){ u/=255; return u<=0.04045 ? u/12.92 : Math.pow((u+0.055)/1.055, 2.4); }
function linearToSrgb(u){ return u<=0.0031308 ? 12.92*u : 1.055*Math.pow(u,1/2.4)-0.055; }
function clamp01(x){ return Math.min(1, Math.max(0, x)); }
function hexToRgb(hex){
  var h = hex.replace('#','').trim();
  var v = h.length===3 ? h.split('').map(function(x){return x+x}).join('') : h;
  return { r: parseInt(v.slice(0,2),16), g: parseInt(v.slice(2,4),16), b: parseInt(v.slice(4,6),16) };
}
function rgbToHex(r,g,b){
  function toHex(v){ return ('0'+Math.round(v).toString(16)).slice(-2); }
  return '#' + toHex(r) + toHex(g) + toHex(b);
}
/* OKLab/OKLCH (Björn Ottosson) */
function rgbToOklab(r8,g8,b8){
  var r = srgbToLinear(r8), g = srgbToLinear(g8), b = srgbToLinear(b8);
  var l = 0.4122214708*r + 0.5363325363*g + 0.0514459929*b;
  var m = 0.2119034982*r + 0.6806995451*g + 0.1073969566*b;
  var s = 0.0883024619*r + 0.2817188376*g + 0.6299787005*b;
  var l_ = Math.cbrt(l), m_ = Math.cbrt(m), s_ = Math.cbrt(s);
  var L = 0.2104542553*l_ + 0.7936177850*m_ - 0.0040720468*s_;
  var a = 1.9779984951*l_ - 2.4285922050*m_ + 0.4505937099*s_;
  var bb= 0.0259040371*l_ + 0.7827717662*s_ - 0.8086757660*m_; // (swap order to keep signs same)
  return {L:L,a:a,b:bb};
}
function oklabToRgb(L,a,b){
  var l_ = Math.pow(L + 0.3963377774*a + 0.2158037573*b, 3);
  var m_ = Math.pow(L - 0.1055613458*a - 0.0638541728*b, 3);
  var s_ = Math.pow(L - 0.0894841775*a - 1.2914855480*b, 3);
  var r =  4.0767416621*l_ - 3.3077115913*m_ + 0.2309699292*s_;
  var g = -1.2684380046*l_ + 2.6097574011*m_ - 0.3413193965*s_;
  var bl=  0.0041960863*l_ - 0.7034186147*m_ + 1.6990625617*s_;
  return {
    r: Math.round(clamp01(linearToSrgb(r))*255),
    g: Math.round(clamp01(linearToSrgb(g))*255),
    b: Math.round(clamp01(linearToSrgb(bl))*255)
  };
}
function oklabToOklch(L,a,b){
  var C = Math.hypot(a,b);
  var h = Math.atan2(b,a) * 180/Math.PI; if(h<0) h += 360;
  return {L:L,C:C,h:h};
}
function oklchToOklab(L,C,h){
  var hr = h * Math.PI/180;
  return {L:L, a: C*Math.cos(hr), b: C*Math.sin(hr)};
}

/* HSL */
function rgbToHsl(r,g,b){
  r/=255; g/=255; b/=255;
  var max=Math.max(r,g,b), min=Math.min(r,g,b);
  var h,s,l=(max+min)/2;
  if(max===min){ h=s=0; }
  else{
    var d=max-min;
    s=l>0.5? d/(2-max-min) : d/(max+min);
    switch(max){
      case r: h=(g-b)/d+(g<b?6:0); break;
      case g: h=(b-r)/d+2; break;
      case b: h=(r-g)/d+4; break;
    }
    h*=60;
  }
  return {h:h,s:s,l:l};
}
function hslToRgb(h,s,l){
  var c=(1-Math.abs(2*l-1))*s, x=c*(1-Math.abs((h/60)%2-1)), m=l-c/2;
  var r=0,g=0,b=0;
  if(0<=h&&h<60){ r=c; g=x; }
  else if(60<=h&&h<120){ r=x; g=c; }
  else if(120<=h&&h<180){ g=c; b=x; }
  else if(180<=h&&h<240){ g=x; b=c; }
  else if(240<=h&&h<300){ r=x; b=c; }
  else { r=c; b=x; }
  return { r:Math.round((r+m)*255), g:Math.round((g+m)*255), b:Math.round((b+m)*255) };
}

/* Hue interpolation */
function hueDelta(h1,h2,mode){
  var diff = ((h2 - h1 + 540) % 360) - 180; // shortest [-180,180]
  if(mode==='short') return diff;
  if(mode==='cw'){ var d = (h2 - h1 + 360) % 360; if(d===0 && h1!==h2) d=360; return d; }
  if(mode==='ccw'){ var d2 = -((h1 - h2 + 360) % 360); if(d2===0 && h1!==h2) d2=-360; return d2; }
  return diff;
}

/* Mixers */
function mix_srgb(c1,c2,t){
  var a=hexToRgb(c1), b=hexToRgb(c2);
  var r=a.r+(b.r-a.r)*t, g=a.g+(b.g-a.g)*t, bl=a.b+(b.b-a.b)*t;
  return rgbToHex(r,g,bl);
}
function mix_hsl(c1,c2,t, path){
  var a=hexToRgb(c1), b=hexToRgb(c2);
  var A=rgbToHsl(a.r,a.g,a.b), B=rgbToHsl(b.r,b.g,b.b);
  var dh = hueDelta(A.h, B.h, path);
  var h = (A.h + dh*t + 360) % 360;
  var s = A.s + (B.s - A.s)*t;
  var l = A.l + (B.l - A.l)*t;
  var R = hslToRgb(h,s,l);
  return rgbToHex(R.r,R.g,R.b);
}
function mix_oklch(c1,c2,t, path, longPath){
  var A=hexToRgb(c1), B=hexToRgb(c2);
  var aLab=rgbToOklab(A.r,A.g,A.b), bLab=rgbToOklab(B.r,B.g,B.b);
  var a=oklabToOklch(aLab.L, aLab.a, aLab.b), b=oklabToOklch(bLab.L, bLab.a, bLab.b);

  var dh = hueDelta(a.h, b.h, path);
  if(longPath && Math.abs(dh) < 180){ dh += (dh>=0? 360 : -360); }

  var L = a.L + (b.L - a.L)*t;
  var C = a.C + (b.C - a.C)*t;
  var h = (a.h + dh*t + 360) % 360;

  var lab = oklchToOklab(L,C,h);
  var rgb = oklabToRgb(lab.L, lab.a, lab.b);
  return rgbToHex(rgb.r, rgb.g, rgb.b);
}

/* Build N color stops across the blend band */
function bandStops(cNow, cNext, p1, p2){
  var N = 24, i, t, col, pos, stops=[];
  var blend = state.blend, path = state.huePath;

  if(blend === 'via-white' || blend === 'via-black'){
    var mid = (p1+p2)/2;
    var midColor = (blend==='via-white') ? '#ffffff' : '#000000';
    return [ cNow+' '+p1+'%', midColor+' '+mid+'%', cNext+' '+p2+'%' ];
  }

  for(i=0;i<=N;i++){
    t = i/N;
    if(blend==='oklch' || blend==='oklch-long'){
      col = mix_oklch(cNow,cNext,t, path, blend==='oklch-long');
    } else if(blend==='hsl'){
      col = mix_hsl(cNow,cNext,t, path);
    } else {
      col = mix_srgb(cNow,cNext,t);
    }
    pos = p1 + (p2 - p1)*t;
    stops.push(col+' '+pos+'%');
  }
  return stops;
}

/* ===== Time → gradient ===== */
function h12(h){ var v = h % 12; return v===0 ? 12 : v; }
function hourColor(hour){ return state.hours[(hour-1+12)%12] || '#ffffff'; }

function update(){
  var now = new Date();
  var cur = h12(now.getHours());
  var next = cur % 12 + 1;

  var cNow  = hourColor(cur);
  var cNext = hourColor(next);

  var t = (now.getMinutes() + now.getSeconds()/60 + now.getMilliseconds()/60000) / 60;

  var p = (1 - t) * 100;       // center % (right→left)
  var band = 22;               // blend band width
  var p1 = Math.max(0, Math.min(100, p - band/2));
  var p2 = Math.max(0, Math.min(100, p + band/2));

  var stops = [ cNow+' 0%', cNow+' '+p1+'%' ]
    .concat(bandStops(cNow, cNext, p1, p2))
    .concat([ cNext+' '+p2+'%', cNext+' 100%' ]).join(',');

  document.body.style.backgroundImage = 'linear-gradient(90deg,'+stops+')';

  requestAnimationFrame(update);
}

/* ===== Boot ===== */
function renderGrain(){ /* defined above */ }  // (kept together for clarity)
buildSwatches();
applyGrain();
update();
</script>
</body>
</html>
